name: Check PRs

on:
  pull_request_target:
    types:
      - synchronize
      - opened

jobs:
  check-prs:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: List Open PRs
        id: list-prs
        run: |
          $prs = Invoke-RestMethod -Method Get -Uri "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&base=${{ github.event.pull_request.base.ref }}"
          $prs | ConvertTo-Json | Out-File prs.json

      - name: Check PRs
        run: |
          $prs = Get-Content prs.json | ConvertFrom-Json
          if ($prs.Count -gt 0) {
            Write-Host "There are other open pull requests for this branch:"
            Write-Host "$prs"
            $env:CHECK_STATUS = "failure"
          } else {
            Write-Host "No other open pull requests for this branch."
            $env:CHECK_STATUS = "success"
          }

      - name: Set Status Check
        run: |
          $status = @{
            owner = $env:GITHUB_REPOSITORY.Split("/")[0]
            repo = $env:GITHUB_REPOSITORY.Split("/")[1]
            sha = $env:GITHUB_SHA
            state = $env:CHECK_STATUS
            context = "Check PRs"
            description = "Check if there are other open pull requests for this branch"
          }
          $status | ConvertTo-Json | Out-File status.json
          $headers = @{
            Authorization = "Bearer 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"
            "Content-Type" = "application/json"
          }
          Invoke-RestMethod -Method Post -Uri "https://api.github.com/repos/${{ github.repository }}/statuses/$env:GITHUB_SHA" -Headers $headers -InFile status.json
