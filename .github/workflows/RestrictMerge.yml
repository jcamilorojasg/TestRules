name: Restrict Merge

on:
  pull_request:
    types:
      - synchronize
      - opened

jobs:
  check-prsRM:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: List Open PRs
        id: list-prs
        run: |
          $prs = Invoke-RestMethod -Method Get -Uri "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&base=${{ github.event.pull_request.base.ref }}"
          echo "prs=$prs" >> $GITHUB_ENV
      - name: Check PRs
        run: |
          $prs = ${{ steps.list-prs.outputs.prs }}
          if ($prs -ne $null) {
            $oldestPR = $prs | ConvertFrom-Json | Sort-Object -Property created_at | Select-Object -First 1
            if ($oldestPR.number -ne $env:GITHUB_PR_NUMBER) {
              echo "::set-output name=check_status::failure"
              echo "There are other open pull requests for this branch:"
              foreach ($pr in $prs) {
                echo "PR Number: $($pr.number)"
                echo $pr
              }
            }
            else {
              echo "::set-output name=check_status::success"
              echo "No other open pull requests for this branch."
            }
          }
          else {
            echo "::set-output name=check_status::success"
            echo "No other open pull requests for this branch."
          }

      - name: Set Status Check
        run: |
          echo "check_status = $env:check_status"
          $status = @{
            owner = $env:GITHUB_REPOSITORY.Split("/")[0]
            repo = $env:GITHUB_REPOSITORY.Split("/")[1]
            sha = $env:GITHUB_SHA
            state = $env:check_status
            context = "Check PRs"
            description = "Check if there are other open pull requests for this branch"
          }
          $token = '${{ secrets.TOKEN_SECRET }}'
          $header = @{
            Authorization = "Bearer ${{ secrets.TOKEN_SECRET }}"
            "Content-Type" = "application/json"
          }
          $apiUrl = "https://api.github.com/repos/$($status.owner)/$($status.repo)/statuses/$($status.sha)"
          echo $apiUrl
          Invoke-RestMethod -Method Post -Uri $apiUrl -Headers $header -ContentType "application/json" -Body ($status | ConvertTo-Json)
